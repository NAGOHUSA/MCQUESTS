name: Generate Minecraft Daily Quest

on:
  schedule:
    - cron: "0 9 * * *"   # 09:00 UTC daily (4â€“5 AM ET depending on DST)
  workflow_dispatch:
    inputs:
      force:
        description: "Overwrite today's quest if it already exists?"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
      # Map your secret to GROQ_API_KEY so groq-sdk picks it up easily
      GROQ_API_KEY: ${{ secrets.GROQ_MCDAILYQUESTS }}
      # Also pass raw in case you prefer reading this name in code:
      GROQ_MCDAILYQUESTS: ${{ secrets.GROQ_MCDAILYQUESTS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: |
          set -euo pipefail
          if [[ -f package-lock.json ]]; then npm ci; else npm i; fi

      - name: Generate today's quest (UTC)
        run: |
          set -euo pipefail
          DATE="$(date -u +%F)"
          echo "Target date: $DATE"

          # Force overwrite on manual runs (or when input says true)
          FORCE="${{ github.event_name == 'workflow_dispatch' && (inputs.force == true) }}"
          if [[ "$FORCE" == "true" ]]; then
            export FORCE="1"
          else
            export FORCE="${FORCE:-0}"
          fi

          # Allow manual override of date if you want someday:
          # TARGET_DATE=2025-11-05 node generate-quest.js
          node generate-quest.js
          test -f "quests/${DATE}.json" || { echo "Missing quests/${DATE}.json"; ls -la quests || true; exit 1; }

      - name: Validate output
        run: |
          set -euo pipefail
          DATE="$(date -u +%F)"
          node validate-quest.js "quests/${DATE}.json"

      - name: Commit & push
        run: |
          set -euo pipefail
          DATE="$(date -u +%F)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "quests/${DATE}.json"
          git commit -m "chore(quests): add ${DATE}.json" || echo "Nothing to commit"
          git push
