<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minecraft Daily Quest</title>
  <meta name="description" content="New vanilla Minecraft quest every day. No mods. Play in any world or seed. Vote once per day and climb the leaderboard." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; --panel:#111936; --accent:#31e081; --accent-2:#ffd24d; --text:#eef3ff; --muted:#9db0ff; --danger:#ff6b6b;
      --border:rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#0d1230 100%);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#3cf19c 0%,#1cb0ff 100%);box-shadow:0 8px 30px rgba(49,224,129,.25)}
    h1{font-size:clamp(22px,4vw,32px);margin:0;font-weight:800;letter-spacing:0.3px}
    .tag{background:rgba(49,224,129,.12);border:1px solid rgba(49,224,129,.35);color:#9ff6c8;padding:4px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){.grid{grid-template-columns:1.4fr .6fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 18px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px 0;font-size:20px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,0.03)}
    .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-accent{border-color:rgba(49,224,129,.55);background:linear-gradient(180deg,rgba(49,224,129,.18),rgba(49,224,129,.10))}
    .btn-danger{border-color:rgba(255,107,107,.5);background:linear-gradient(180deg,rgba(255,107,107,.18),rgba(255,107,107,.10))}
    .stars{display:flex;gap:8px;align-items:center}
    .star{font-size:28px;cursor:pointer;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .star.off{opacity:.35}
    .hr{height:1px;border:0;background:var(--border);margin:14px 0}
    .list{display:flex;flex-direction:column;gap:10px;max-height:350px;overflow:auto}
    .list a{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;text-decoration:none;background:rgba(255,255,255,.02)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#0c132b;border:1px solid var(--border);border-radius:6px;padding:2px 6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .hint{font-size:12px;opacity:.8}
    .success{color:#9ff6c8}
    .warn{color:var(--danger)}
    footer{opacity:.7;margin-top:18px;font-size:12px}
    /* completion chips */
    .step{display:flex;align-items:flex-start;gap:10px;margin:8px 0}
    .chk{accent-color:#31e081;min-width:18px;min-height:18px;margin-top:2px}
    .step.done span{text-decoration:line-through;opacity:.75}
    /* leaderboard tags */
    .lb-pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:11px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <div>
        <h1>Minecraft Daily Quest</h1>
        <div class="row"><span class="tag">Vanilla • No mods • Any seed</span></div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Today + Archive -->
      <div class="card">
        <h2>Today’s Quest <span id="questDate" class="muted"></span></h2>
        <div id="questLoading" class="muted">Loading today’s quest…</div>
        <div id="questBox" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="pill" id="questBiome">Biome: —</span>
              <span class="pill" id="questReward">Reward: —</span>
              <span class="pill" id="questTheme">Theme: —</span>
            </div>
            <span class="pill">ID: <span id="questId" class="kbd"></span></span>
          </div>

          <h3 id="questTitle" style="margin:12px 0 8px 0"></h3>
          <div id="questLore" class="muted" style="white-space:pre-wrap"></div>

          <div class="hr"></div>
          <div>
            <strong>Steps:</strong>
            <div id="questSteps" style="margin-top:8px"></div>
            <div id="questProgress" class="hint" style="margin-top:6px"></div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div class="muted hint">Rate today’s quest (once per device):</div>
              <div class="stars" id="starRow" aria-label="Rate 1 to 5">
                <span class="star off" data-star="1">★</span>
                <span class="star off" data-star="2">★</span>
                <span class="star off" data-star="3">★</span>
                <span class="star off" data-star="4">★</span>
                <span class="star off" data-star="5">★</span>
              </div>
              <div id="voteMsg" class="hint" style="margin-top:6px"></div>
            </div>
            <button id="voteBtn" class="btn btn-accent">Submit Vote</button>
          </div>

          <div class="hr"></div>
          <div class="muted hint" id="statsLine">Ratings: —</div>
        </div>

        <div class="hr"></div>
        <h2>Archive</h2>
        <div class="hint muted">Browse previous quests and tap to preview.</div>
        <div id="archiveList" class="list" style="margin-top:8px">
          <div class="muted">Loading archive…</div>
        </div>
      </div>

      <!-- RIGHT: How it works + Leaderboard -->
      <div class="card">
        <h2>How it works</h2>
        <ul style="margin:8px 0 10px 18px;line-height:1.5">
          <li>A new <strong>vanilla</strong> quest drops every day. No commands, no mods—<em>works in any world/seed</em>.</li>
          <li>Check off steps as you go—progress is saved <strong>on your device</strong>.</li>
          <li>Rate it with <strong>stars</strong> (once per device). We record anonymous votes in Supabase.</li>
          <li>See older quests in the <strong>Archive</strong> and the <strong>Top-Rated Leaderboard</strong>.</li>
        </ul>
        <div class="hr"></div>
        <h2>Top-Rated Leaderboard</h2>
        <div class="hint muted">Based on average stars (Supabase free tier).</div>
        <div id="lbWrap" style="margin-top:8px">
          <div class="muted">Loading leaderboard…</div>
        </div>
      </div>
    </div>

    <footer>
      Data: <span class="kbd">/quests/*.json</span> from GitHub • Votes via Supabase (insert-only RLS) • No Google Apps Script required.
    </footer>
  </div>

<!-- =========================
     SUPABASE CONFIG (EDIT)
     ========================= -->
<script>
  // Paste your project creds (safe to expose anon key with RLS)
  window.SUPABASE_REST_URL = "https://YOUR_PROJECT.supabase.co/rest/v1";
  window.SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

  // Optional: if you only created the earlier 'votes' table/use 'votes_aggregate'
  // set this to true and we’ll map stars→(fun/okay/hard) and read that view.
  window.SUPABASE_COMPAT_VOTES = false; // set true if using votes/votes_aggregate

  // View/table names (change if you used different names)
  window.SUPABASE_TABLE_RATINGS = "ratings";
  window.SUPABASE_VIEW_RATINGS_AGG = "ratings_aggregate";
  window.SUPABASE_TABLE_VOTES = "votes";
  window.SUPABASE_VIEW_VOTES_AGG = "votes_aggregate";
</script>

<script>
/** =======================
 *  CONTENT CONFIG
 *  ======================= */
const RAW_BASE = "https://raw.githubusercontent.com/NAGOHUSA/MCQUESTS/main/quests";
const CONTENTS_API = "https://api.github.com/repos/NAGOHUSA/MCQUESTS/contents/quests";

const $ = (sel)=>document.querySelector(sel);
const todayStr = (d=new Date())=>{
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
};
const fmt = (n)=>n.toLocaleString();
function toast(el,msg,cls=""){ el.textContent = msg; el.className = `hint ${cls}`; }

/** ===== State ===== */
let currentQuest = null;
let selectedStars = 0;
let userId = localStorage.getItem("mcq_userid");
if(!userId){
  userId = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem("mcq_userid", userId);
}

/** ===== Fetch a quest JSON by date ===== */
async function getQuest(date){
  const url = `${RAW_BASE}/${date}.json`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`Quest ${date} not found (${res.status})`);
  return res.json();
}

/** ===== Load today's quest, fallback to latest in archive ===== */
async function loadToday(){
  const date = todayStr();
  $("#questDate").textContent = date;
  try{
    currentQuest = await getQuest(date);
    renderQuest(currentQuest, date);
  }catch(e){
    const items = await (await fetch(CONTENTS_API, {cache:"no-store"})).json();
    const files = (Array.isArray(items)?items:[]).filter(x=>x.type==="file" && x.name.endsWith(".json"));
    if(!files.length) throw e;
    files.sort((a,b)=> b.name.localeCompare(a.name));
    const latest = files[0].name.replace(".json","");
    $("#questDate").textContent = `${date} (showing latest available: ${latest})`;
    currentQuest = await getQuest(latest);
    renderQuest(currentQuest, latest);
  }
}

/** ===== Render quest + completion checkboxes ===== */
function renderQuest(q, dateKey){
  $("#questLoading").style.display="none";
  $("#questBox").style.display="block";

  const title = q.title || q.name || q.questTitle || "Untitled Quest";
  const lore  = q.lore || q.description || q.flavor || "";
  const steps = q.steps || q.objectives || q.tasks || [];
  const biome = q.biome_hint || q.biome || "Any";
  const reward = q.reward || q.points || "Bragging rights";
  const id = q.id || dateKey;
  const theme = q.theme || "Weekly Theme";
  const color = q.color || "#5c7cfa";

  // accent chip color
  document.documentElement.style.setProperty("--accent", color);

  $("#questTitle").textContent = title;
  $("#questLore").textContent = lore;
  $("#questBiome").textContent = "Biome: " + biome;
  $("#questReward").textContent = "Reward: " + reward;
  $("#questTheme").textContent = "Theme: " + theme;
  $("#questId").textContent = id;

  // Steps with completion (localStorage)
  const list = $("#questSteps");
  list.innerHTML = "";
  const key = (i)=>`mcq:${id}:step:${i}:done`;
  const checkRender = ()=>{
    const total = steps.length;
    const done = steps.filter((_,i)=> localStorage.getItem(key(i))==="1").length;
    $("#questProgress").textContent = `Progress: ${done}/${total} steps complete`;
  };
  (steps || []).slice(0,3).forEach((s,i)=>{
    const wrap = document.createElement("div");
    wrap.className = "step";
    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.className = "chk";
    chk.checked = localStorage.getItem(key(i))==="1";
    const label = document.createElement("span");
    label.textContent = s;
    wrap.appendChild(chk); wrap.appendChild(label);
    if(chk.checked) wrap.classList.add("done");
    chk.addEventListener("change", ()=>{
      localStorage.setItem(key(i), chk.checked ? "1" : "0");
      wrap.classList.toggle("done", chk.checked);
      checkRender();
    });
    list.appendChild(wrap);
  });
  checkRender();

  // load stats + voting guard
  loadStats(id, theme);
  const votedKey = `voted-${id}`;
  if(localStorage.getItem(votedKey)){
    $("#voteBtn").disabled = true;
    toast($("#voteMsg"), "You already voted for this quest on this device.", "success");
  }else{
    toast($("#voteMsg"), "Tap a star, then Submit Vote.");
  }
}

/** ===== Stars UI ===== */
function wireStars(){
  const stars = [...document.querySelectorAll(".star")];
  stars.forEach(st=>{
    st.addEventListener("click", ()=>{
      selectedStars = Number(st.dataset.star);
      stars.forEach((el,i)=> el.classList.toggle("off", (i+1)>selectedStars));
    });
  });
}

/** =========================
 *  SUPABASE helpers
 *  ========================= */
function supaCfgOk(){
  return !!(window.SUPABASE_REST_URL && window.SUPABASE_ANON_KEY);
}
async function supaInsertRating({date,theme,stars}){
  const url = `${window.SUPABASE_REST_URL}/${window.SUPABASE_TABLE_RATINGS}`;
  const user_hash = await sha16(navigator.userAgent + new Date().toDateString());
  const payload = { date, theme, stars, ua: navigator.userAgent, user_hash };
  const res = await fetch(url, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey": window.SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${window.SUPABASE_ANON_KEY}`,
      "Prefer":"return=minimal"
    },
    body: JSON.stringify(payload)
  });
  return res.ok;
}
async function supaInsertVoteCompat({date,theme,stars}){
  // Map stars → option for the older 'votes' table
  const option = stars>=4 ? "fun" : (stars===3 ? "okay" : "hard");
  const url = `${window.SUPABASE_REST_URL}/${window.SUPABASE_TABLE_VOTES}`;
  const user_hash = await sha16(navigator.userAgent + new Date().toDateString());
  const payload = { date, theme, option, ua: navigator.userAgent, user_hash };
  const res = await fetch(url, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey": window.SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${window.SUPABASE_ANON_KEY}`,
      "Prefer":"return=minimal"
    },
    body: JSON.stringify(payload)
  });
  return res.ok;
}
async function supaGetAggregate(date){
  // Try ratings_aggregate first; fallback to votes_aggregate
  const urlRatings = `${window.SUPABASE_REST_URL}/${window.SUPABASE_VIEW_RATINGS_AGG}?date=eq.${encodeURIComponent(date)}`;
  const urlVotes = `${window.SUPABASE_REST_URL}/${window.SUPABASE_VIEW_VOTES_AGG}?date=eq.${encodeURIComponent(date)}`;

  const headers = { "apikey": window.SUPABASE_ANON_KEY, "Authorization": `Bearer ${window.SUPABASE_ANON_KEY}` };

  // prefer ratings_aggregate
  try{
    const r = await fetch(urlRatings, { headers, cache:"no-store" });
    if(r.ok){
      const arr = await r.json();
      if(Array.isArray(arr) && arr.length){
        // pick first row (date+theme)
        const row = arr[0];
        return { count: Number(row.count||0), avg: Number(row.avg||0) };
      }
    }
  }catch(_) {}
  // fallback: votes_aggregate (compute avg)
  try{
    const r = await fetch(urlVotes, { headers, cache:"no-store" });
    if(r.ok){
      const rows = await r.json();
      if(Array.isArray(rows) && rows.length){
        const counts = rows.reduce((m,row)=>{ m[row.option]=Number(row.count)||0; return m; },{});
        const total = (counts.fun||0)+(counts.okay||0)+(counts.hard||0);
        const avg = total ? (((counts.fun||0)*5)+((counts.okay||0)*3)+((counts.hard||0)*2))/total : 0;
        return { count: total, avg };
      }
    }
  }catch(_) {}
  return { count: 0, avg: 0 };
}
async function supaGetLeaderboard(limit=10){
  // Prefer ratings_aggregate ordered by avg desc / count desc
  const urlRatings = `${window.SUPABASE_REST_URL}/${window.SUPABASE_VIEW_RATINGS_AGG}?select=date,theme,count,avg&order=avg.desc,count.desc&limit=${limit}`;
  const urlVotes = `${window.SUPABASE_REST_URL}/${window.SUPABASE_VIEW_VOTES_AGG}?select=date,option,count&limit=10000`;
  const headers = { "apikey": window.SUPABASE_ANON_KEY, "Authorization": `Bearer ${window.SUPABASE_ANON_KEY}` };

  try{
    const r = await fetch(urlRatings, { headers, cache:"no-store" });
    if(r.ok){
      const arr = await r.json();
      if(Array.isArray(arr) && arr.length) return arr.map(x=>({date:x.date, theme:x.theme, count:Number(x.count), avg:Number(x.avg)}));
    }
  }catch(_){}

  // fallback: compute from votes_aggregate
  try{
    const r = await fetch(urlVotes, { headers, cache:"no-store" });
    if(r.ok){
      const rows = await r.json();
      const byDate = {};
      rows.forEach(row=>{
        const d = row.date;
        byDate[d] = byDate[d] || {date:d, count:0, sum:0};
        const c = Number(row.count||0);
        const val = row.option==="fun"?5: row.option==="okay"?3:2;
        byDate[d].count += c;
        byDate[d].sum += c*val;
      });
      const arr = Object.values(byDate).map(x=>({date:x.date, theme:"—", count:x.count, avg: x.count? x.sum/x.count : 0}));
      arr.sort((a,b)=> b.avg - a.avg || b.count - a.count);
      return arr.slice(0, limit);
    }
  }catch(_){}
  return [];
}
async function sha16(s){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,16);
}

/** ===== Submit vote ===== */
async function submitVote(){
  if(!supaCfgOk()){
    toast($("#voteMsg"), "Supabase not configured. Add REST URL + anon key.", "warn");
    return;
  }
  if(!currentQuest){ return; }
  if(!selectedStars){ toast($("#voteMsg"), "Choose a rating first (1–5 stars).", "warn"); return;}

  const dateKey = $("#questId").textContent || todayStr();
  const theme = $("#questTheme").textContent.replace(/^Theme:\s*/,'') || "Theme";
  const votedKey = `voted-${dateKey}`;
  if(localStorage.getItem(votedKey)){
    toast($("#voteMsg"), "You already voted for this quest on this device.", "success"); return;
  }

  $("#voteBtn").disabled = true;
  toast($("#voteMsg"), "Submitting your vote…");

  try{
    let ok = false;
    if(!window.SUPABASE_COMPAT_VOTES){
      ok = await supaInsertRating({date:dateKey, theme, stars:selectedStars});
      if(!ok){
        // if ratings table missing, fallback to votes compat
        ok = await supaInsertVoteCompat({date:dateKey, theme, stars:selectedStars});
      }
    }else{
      ok = await supaInsertVoteCompat({date:dateKey, theme, stars:selectedStars});
    }

    if(!ok) throw new Error("insert failed");
    localStorage.setItem(votedKey, String(selectedStars));
    toast($("#voteMsg"), "Vote saved. Thank you!", "success");
    const stats = await supaGetAggregate(dateKey);
    $("#statsLine").textContent = `Ratings: ${fmt(stats.count)} • Avg ${Number(stats.avg||0).toFixed(2)} ★`;
  }catch(err){
    console.error(err);
    $("#voteBtn").disabled = false;
    toast($("#voteMsg"), "Could not submit vote. Try again in a bit.", "warn");
  }
}

/** ===== Stats for a given date (ratings) ===== */
async function loadStats(dateKey){
  if(!supaCfgOk()){
    $("#statsLine").textContent = `Ratings: configure Supabase to see live stats.`;
    return;
  }
  const stats = await supaGetAggregate(dateKey);
  $("#statsLine").textContent = stats.count ? `Ratings: ${fmt(stats.count)} • Avg ${Number(stats.avg||0).toFixed(2)} ★` : `Ratings: —`;
}

/** ===== Leaderboard (top by avg) ===== */
async function loadLeaderboard(){
  const wrap = $("#lbWrap");
  if(!supaCfgOk()){
    wrap.innerHTML = `<div class="muted">Add Supabase REST URL + anon key to enable the leaderboard.</div>`;
    return;
  }
  const rows = await supaGetLeaderboard(10);
  if(!rows.length){ wrap.innerHTML = `<div class="muted">No ratings yet.</div>`; return; }
  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr><th>#</th><th>Date</th><th>Avg ★</th><th>Votes</th><th></th></tr></thead>
    <tbody>${rows.map((r,i)=>`
      <tr>
        <td>${i+1}</td>
        <td><a href="#" data-date="${r.date}" class="open-date">${r.date}</a></td>
        <td>${(r.avg||0).toFixed(2)}</td>
        <td>${fmt(Number(r.count||0))}</td>
        <td><span class="lb-pill">${r.theme||"—"}</span></td>
      </tr>`).join("")}</tbody>
  `;
  wrap.innerHTML = "";
  wrap.appendChild(table);

  // click row to open that quest
  wrap.querySelectorAll("a.open-date").forEach(a=>{
    a.addEventListener("click", async e=>{
      e.preventDefault();
      const date = a.dataset.date;
      try{
        const q = await getQuest(date);
        $("#questDate").textContent = date;
        currentQuest = q;
        renderQuest(q, date);
        window.scrollTo({top:0,behavior:"smooth"});
      }catch(_){ alert("Quest JSON not found for that date."); }
    });
  });
}

/** ===== Archive ===== */
async function loadArchive(){
  const res = await fetch(CONTENTS_API, {cache:"no-store"});
  const items = await res.json();
  const files = (Array.isArray(items)?items:[]).filter(x=>x.type==="file" && x.name.endsWith(".json"));
  files.sort((a,b)=> b.name.localeCompare(a.name));
  const container = $("#archiveList");
  container.innerHTML = "";
  if(!files.length){ container.innerHTML = `<div class="muted">No quests found yet.</div>`; return; }

  files.forEach(f=>{
    const date = f.name.replace(".json","");
    const el = document.createElement("a");
    el.href="#";
    el.innerHTML = `<span>${date}</span><span class="muted">open</span>`;
    el.addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        const q = await getQuest(date);
        $("#questDate").textContent = `${date}`;
        currentQuest = q;
        renderQuest(q, date);
        window.scrollTo({top:0,behavior:"smooth"});
      }catch(err){ alert("Could not load that quest."); }
    });
    container.appendChild(el);
  });
}

/** ===== Init ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  wireStars();
  $("#voteBtn").addEventListener("click", submitVote);
  try{
    await loadToday();
  }catch(err){
    $("#questLoading").textContent = "No quest found yet for today.";
  }
  loadArchive();
  loadLeaderboard();
});
</script>
</body>
</html>
