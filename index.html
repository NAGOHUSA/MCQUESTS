<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MC Daily Quests</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #d0f4ff;
      --text: #1a1a1a;
      --primary: #4caf50;
      --secondary: #66bb6a;
      --accent: #ffd700;
      --panel: #f1f8e9;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Press Start 2P', cursive;
      background: var(--bg);
      color: var(--text);
      padding: 1rem;
      margin: 0;
    }
    h1 {
      text-align: center;
      font-size: 1.6rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      text-shadow: 2px 2px white;
    }
    .section {
      background: var(--panel);
      border: 4px solid var(--primary);
      border-radius: 14px;
      padding: 1.2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h2 { color: var(--primary); margin-bottom: 1rem; font-size: 1rem; }
    input, button {
      width: 100%;
      font-family: inherit;
      font-size: 1rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border: 2px solid var(--primary);
      border-radius: 8px;
    }
    button {
      background: var(--primary);
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: var(--secondary);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }
    .archive-card {
      background: white;
      border: 2px solid var(--secondary);
      border-radius: 10px;
      padding: 1rem;
      font-size: 0.85rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 0.4rem;
      text-align: left;
    }
    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      vertical-align: middle;
      margin-right: 6px;
    }
    #myStats {
      display: none;
      margin-top: 1rem;
      font-size: 0.85rem;
    }
    .highlight {
      background: var(--accent);
      padding: 0.2rem 0.4rem;
      border-radius: 5px;
    }
    @media(max-width: 600px) {
      h1 { font-size: 1.3rem; }
      table { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <h1>üß± MC Daily Quests</h1>

  <div class="section">
    <div id="quest">Loading quest...</div>
  </div>

  <div class="section">
    <h2>üéÆ Submit Your Quest</h2>
    <input type="text" id="player" placeholder="Minecraft Username" />
    <input type="text" id="seed" placeholder="World Seed" />
    <button onclick="submitQuest()">Submit Quest</button>
    <div id="submitStatus"></div>
  </div>

  <div class="section">
    <h2>üìö Quest Archive</h2>
    <div class="grid" id="archive"><div>Loading...</div></div>
  </div>

  <div class="section">
    <h2>üèÜ Leaderboard</h2>
    <div id="questHero">Loading top player...</div>
    <table id="leaderboardTable">
      <thead>
        <tr><th>#</th><th>Player</th><th>Score</th></tr>
      </thead>
      <tbody><tr><td colspan="3">Loading...</td></tr></tbody>
    </table>

    <div id="myStats">
      <p><strong>Your Stats</strong></p>
      <p><img id="statAvatar" class="avatar" src="" /> <strong id="statName"></strong></p>
      <p>‚≠ê Score: <span id="statScore"></span></p>
      <p>üèÖ Rank: <span id="statRank"></span></p>
    </div>
  </div>

  <div class="section">
    <h2>üìî Adventure Log</h2>
    <div id="log">No quests submitted yet.</div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9YCDjzo6GE-sRHgLwU9ZzWeLdC2ugK5t0mc7uJsg8b0nl-7ec59JOewFopLzlPlKurQ/exec';
    const today = new Date().toISOString().split('T')[0];

    async function getQuestDates() {
      try {
        const res = await fetch('https://api.github.com/repos/NAGOHUSA/MCQUESTS/contents/quests');
        const files = await res.json();
        return files.filter(f => f.name.endsWith('.json')).map(f => f.name.replace('.json', '')).sort((a, b) => b.localeCompare(a));
      } catch (err) {
        console.error('Could not fetch quest dates:', err);
        return [];
      }
    }

    async function loadQuest(date, container = 'quest') {
      const url = `https://raw.githubusercontent.com/NAGOHUSA/MCQUESTS/main/quests/${date}.json`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Quest not found');
        const q = await res.json();
        document.getElementById(container).innerHTML = `
          <div class="quest-block">
            <h2>${q.title}</h2>
            <p><em>${q.lore}</em></p>
            <h3>Steps:</h3>
            <ol>${q.steps.map(s => `<li>${s}</li>`).join('')}</ol>
            <h3>Reward:</h3>
            <p>${q.reward}</p>
            <p><strong>Biome:</strong> ${q.biomeHint}</p>
            <p><small>ID: ${q.id}</small></p>
          </div>`;
      } catch (err) {
        document.getElementById(container).innerHTML = `<p>‚ö†Ô∏è Quest not found for ${date}</p>`;
      }
    }

    async function submitQuest() {
      const player = document.getElementById('player').value.trim();
      const seed = document.getElementById('seed').value.trim();
      if (!player) return alert('Please enter your Minecraft username!');
      const payload = { player, questID: today, seed, score: 1 };
      document.getElementById('submitStatus').textContent = 'Submitting...';
      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        document.getElementById('submitStatus').textContent = txt.includes('Success') ? '‚úÖ Submitted!' : `‚ö†Ô∏è ${txt}`;
        saveLocalQuest(player, today, seed);
        loadLeaderboard(player);
      } catch {
        document.getElementById('submitStatus').textContent = '‚ùå Submission error.';
      }
    }

    function saveLocalQuest(player, quest, seed) {
      localStorage.setItem('mcqPlayer', player);
      const log = JSON.parse(localStorage.getItem('nagohQuests') || '[]');
      log.push({ player, quest, seed, date: new Date().toLocaleDateString() });
      localStorage.setItem('nagohQuests', JSON.stringify(log));
      updateLog();
    }

    function updateLog() {
      const log = JSON.parse(localStorage.getItem('nagohQuests') || '[]');
      const div = document.getElementById('log');
      div.innerHTML = log.length === 0
        ? 'No quests submitted yet.'
        : log.map(l => `‚Ä¢ ${l.date} ‚Äì <strong>${l.player}</strong> ‚Äì Quest ${l.quest}`).join('<br>');
    }

    async function loadLeaderboard(currentPlayer = '') {
      try {
        const res = await fetch(GOOGLE_SCRIPT_URL);
        const data = await res.json();
        const tbody = document.querySelector('#leaderboardTable tbody');
        tbody.innerHTML = '';
        let topPlayer = data[0]?.player || '';
        data.forEach((p, i) => {
          const avatar = `<img class="avatar" src="https://minotar.net/avatar/${p.player}/32" alt="${p.player}" />`;
          tbody.innerHTML += `
            <tr>
              <td>${i + 1}</td>
              <td>${avatar}${p.player}</td>
              <td>${p.score}</td>
            </tr>`;
        });
        document.getElementById('questHero').innerHTML = `üéâ <span class="highlight">Hero of the Day: ${topPlayer}</span>`;
        if (currentPlayer) {
          const me = data.find(p => p.player.toLowerCase() === currentPlayer.toLowerCase());
          if (me) {
            const rank = data.findIndex(p => p.player.toLowerCase() === currentPlayer.toLowerCase()) + 1;
            document.getElementById('statName').textContent = me.player;
            document.getElementById('statScore').textContent = me.score;
            document.getElementById('statRank').textContent = rank;
            document.getElementById('statAvatar').src = `https://minotar.net/avatar/${me.player}/32`;
            document.getElementById('myStats').style.display = 'block';
          }
        }
      } catch (err) {
        document.querySelector('#leaderboardTable tbody').innerHTML = '<tr><td colspan="3">‚ö†Ô∏è Error loading leaderboard</td></tr>';
      }
    }

    async function loadArchive() {
      const dates = await getQuestDates();
      const archive = document.getElementById('archive');
      archive.innerHTML = '';
      const latest = dates.slice(0, 6);
      for (let i = 0; i < latest.length; i++) {
        const card = document.createElement('div');
        card.className = 'archive-card';
        card.id = `a${i}`;
        archive.appendChild(card);
        loadQuest(latest[i], `a${i}`);
      }
    }

    (async () => {
      const dates = await getQuestDates();
      const todayAvailable = dates.includes(today);
      const questToLoad = todayAvailable ? today : dates[0];
      loadQuest(questToLoad, 'quest');
      loadArchive();
      updateLog();
      const savedPlayer = localStorage.getItem('mcqPlayer');
      if (savedPlayer) {
        document.getElementById('player').value = savedPlayer;
        loadLeaderboard(savedPlayer);
      } else {
        loadLeaderboard();
      }
    })();
  </script>
</body>
</html>
